
stages:
 - test
 - build


tests:
    stage: test
    image: maven:3.8.3-openjdk-17
    script:
        - mvn -q test

build_image:
  image: docker:20
  services:
    - docker:20-dind

  stage: build

  variables:
    DOCKER_DRIVER: "overlay2"
    CONTAINER_REPOSITORY: "pvt2023/backend"
    VERSION: "1.0"

  before_script:
    - apk update && apk add jq
    - docker login -u "$DOCKER_CLIENT" -p "$DOCKER_SECRET"

  script:
    - echo "Building website version $DOCKER_IMAGE_TAG"
    - docker build -t $CONTAINER_REPOSITORY:comment-api-$VERSION comment-api
    - docker push $CONTAINER_REPOSITORY:comment-api-$VERSION
    - docker build -t $CONTAINER_REPOSITORY:exercise-api-$VERSION exercise-api
    - docker push $CONTAINER_REPOSITORY:exercise-api-$VERSION
    - docker build -t $CONTAINER_REPOSITORY:gateway-$VERSION gateway
    - docker push $CONTAINER_REPOSITORY:gateway-$VERSION
    - docker build -t $CONTAINER_REPOSITORY:plan-api-$VERSION plan-api
    - docker push $CONTAINER_REPOSITORY:plan-api--$VERSION
    - docker build -t $CONTAINER_REPOSITORY:session-api-$VERSION session-api
    - docker push $CONTAINER_REPOSITORY:session-api-$VERSION
    - docker build -t $CONTAINER_REPOSITORY:tag-api-$VERSION tag-api
    - docker push $CONTAINER_REPOSITORY:tag-api--$VERSION
    - docker build -t $CONTAINER_REPOSITORY:techniques-api-$VERSION techniques-api
    - docker push $CONTAINER_REPOSITORY:techniques-api-$VERSION
    - docker build -t $CONTAINER_REPOSITORY:user-$VERSION user
    - docker push $CONTAINER_REPOSITORY:user-$VERSION
    - docker build -t $CONTAINER_REPOSITORY:usersettings-api-$VERSION usersettings-api
    - docker push $CONTAINER_REPOSITORY:usersettings-api-$VERSION
    - docker build -t $CONTAINER_REPOSITORY:workout-api-$VERSION workout-api
    - docker push $CONTAINER_REPOSITORY:workout-api-$VERSION
  only:
    - main

